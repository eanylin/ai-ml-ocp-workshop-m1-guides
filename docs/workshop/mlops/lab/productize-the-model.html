<!DOCTYPE html>
<html>
<head>
  <title>
      The MLOps Workshop
  </title>
  <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="gRlpodFqrxifNejD73KXyzzaBkNaJSExYyErHgNr3kvp1iihxM6hVaSNwcClCIS8N8FDLO8RLUROEhWvhdFZBA==" />
  <link rel="stylesheet" media="all" href="../../../assets/application-dcf5640dabe7c086c5db76b2e378b4def3309902bc32af61ab63094a23e1730b.css" data-turbolinks-track="reload" />
  <script src="../../../assets/application-1763c4134299cf1911a383dd8d9b23b574b429196c500fbba1a010629fc4c558.js" data-turbolinks-track="reload"></script>
</head>

<script type="text/javascript">
function gowithuser() {
    window.location.search = ('&userid=' + document.getElementById('useridfield').value);
}
function recycle() {
  window.location.search = ('&userid=reset');
}
</script>

<body>
<nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid d-flex justify-content-start">
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarContent">
      <span class="navbar-toggler-icon"></span>
    </button>
      <a class="navbar-brand mb-0 h1" href="../../mlops.html" id="workshopName">The MLOps Workshop</a>
        <span class="navbar-text" style="margin-right: 1rem;">|</span>
        <span class="navbar-text">Productize the Model</span>
        <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">|</span>
        <span class="navbar-text">User ID: user1</span>
        <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i onclick="recycle();" style="color: green;" class="fa fa-recycle" aria-hidden="true"></i></span>
  </div>
</nav>

<script type="application/javascript">
    if (App.hasOwnProperty('subscription_id')) {
        App.cable.subscriptions.remove(App.subscription_id);
    }

    App.subscription_id = App.report_page_view('mlops#productize-the-model', 'd9172ed7-510d-408a-b653-5c241996eae0');
</script>

<main class="container-fluid">
  <div class="row">
    <div class="col-md-3">
      <ul class="list-group" id="labs-menu">
            <a href="../../mlops.html" class="list-group-item list-group-item-action list-group-item-success">
              1. Kubernetes Overview
            </a>
            <a href="navigating-openshift-ui.html" class="list-group-item list-group-item-action list-group-item-success">
              2. Navigating OpenShift Web Console
            </a>
            <a href="getting-started-mlops.html" class="list-group-item list-group-item-action list-group-item-success">
              3. Getting Started with MLOps
            </a>
            <a href="workshop-environment.html" class="list-group-item list-group-item-action list-group-item-success">
              4. Your Workshop Environment
            </a>
            <a href="exploring-data.html" class="list-group-item list-group-item-action list-group-item-success">
              5. Exploring Data
            </a>
            <a href="building-the-first-model.html" class="list-group-item list-group-item-action list-group-item-success">
              6. Build the First Model
            </a>
            <li class="list-group-item active">
              <span>7. Productize the Model</span>
            </li>
            <a href="deploy-to-staging.html" class="list-group-item list-group-item-action">
              8. Deploy The Model To Staging
            </a>
            <a href="promote-to-production.html" class="list-group-item list-group-item-action">
              9. Promote to Production
            </a>
            <a href="model-observability.html" class="list-group-item list-group-item-action">
              10. Model Monitoring and Observability
            </a>
            <a href="continuous-training.html" class="list-group-item list-group-item-action">
              11. Continuous Training With A/B Testing
            </a>
            <a href="decide-on-final-model.html" class="list-group-item list-group-item-action">
              12. Deploy The Chosen One
            </a>
            <a href="integrate-with-application-services.html" class="list-group-item list-group-item-action">
              13. Completing the Solution with Red Hat Application Services
            </a>
        <a href="../complete.html" class="list-group-item list-group-item-action list-group-item-warning">
          <i class="fa fa-print"></i> All labs in one page
        </a>
      </ul>
    </div>
    <div class="col-md-9">
      <div class="card" id="lab-content">
        <div class="card-header">
          <h6>
            <span class="pull-left badge badge-pill badge-primary">7</span>
            <span class="pull-left ml-2">Productize the Model</span>
          </h6>
        </div>
        <div class="card-body">
          <div class="sect1">
<h2 id="_productize_the_model">Productize The Model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now the model has been created, we will now begin to productize the model in the development environment.</p>
</div>
<div class="paragraph">
<p>We will be using CodeReady Workspaces and <code>juyptext</code> to convert
the notebook to python code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_logging_into_codeready_workspaces">Logging Into CodeReady Workspaces</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You will be using Red Hat CodeReady Workspaces, an online IDE based on
Eclipse Che. Built on the open Eclipse Che project, Red Hat CodeReady
Workspaces uses Kubernetes and containers to provide any member of the
development or IT team with a consistent, secure, and zero-configuration
development environment. The user experience is as fast and familiar as
an integrated development environment (IDE) on their laptop.</p>
</div>
<div class="paragraph">
<p>CodeReady Workspaces is included in OpenShift® and is available in the
OpenShift Operator Hub. Once deployed, CodeReady Workspaces provides
development teams a faster and more reliable foundation on which to
work, and it gives operations centralized control and peace of mind.</p>
</div>
<div class="paragraph">
<p>To get started, <a href="https://codeready-labs-infra.apps.cluster-844c.844c.example.opentlc.com" target="_blank" rel="noopener">access the
CodeReady Workspaces instance</a>, and log in using the username and
password you’ve been assigned
(e.g. <code>user1/r3dh4t1!</code>):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../asset/images/che-login.png" alt="che-login">
</div>
</div>
<div class="paragraph">
<p>Once you log in, you’ll be placed on your personal dashboard. Click on
the name of the pre-created user1-workspace on the bottom left, as shown below (the
name will be different depending on your assigned number).</p>
</div>
<div class="paragraph">
<p>After a minute or two, you’ll be placed in the workspace:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../asset/images/che-workspace.png" alt="che-workspace">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If things get weird or your browser appears, you can simply reload the
browser tab to refresh the view.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This IDE is based on Eclipse Che (which is in turn based on MicroSoft VS
Code editor).</p>
</div>
<div class="paragraph">
<p>You can see icons on the left for navigating between project explorer,
search, version control (e.g. Git), debugging, and other plugins. You’ll
use these during the course of this workshop. Feel free to click on them
and see what they do:</p>
</div>
<div class="paragraph">
<p>Your git repositories will be cloned to <code>/projects</code> automatically for you:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>rh-mlops-workshop: Source repository for the model</p>
</li>
<li>
<p>rh-mlops-model-deploy: Kubernetes deployment artifacts</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>Changes to files are auto-saved every few seconds</em>, so you don’t need
to explicitly save changes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_converting_a_notebook_to_python_code">Converting A Notebook To Python Code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Within your workspace, click on <strong>&gt;_ New Terminal</strong>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can open a terminal
window for any of the containers running in your Developer workspace.
For the rest of these labs, anytime you need to run a command in a
terminal, you can use the <strong>&gt;_ New Terminal</strong> command on the right. If the new terminal takes too long to launch or the user interface freezes, try refreshing the browser or restarting the workspace.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="../asset/images/che-terminal.png" alt="che-terminal">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To restart the workspace: On the CodeReady main page, click on the Workspaces you are using, and then click the "Stop" button next to your new workspace. You may get an error popup which you can ignore. Then, click the "Start" button to restart the workspace.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="../asset/images/start-stop-codeready-workspaces.png" alt="start-stop-codeready-workspaces">
</div>
</div>
<div class="paragraph">
<p>Run the following commands to convert a notebook into a python code.</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">pip install jupytext
cd /projects/rh-mlops-workshop/notebooks/
jupytext &quot;2 building the first model.ipynb&quot;  -o ../src/train/lr.py</code></pre>
</div>
</div>
<div class="paragraph">
<p>To inspect the newly converted file, the user can navigate from the file explorer under "Open File"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../asset/images/codeready-file-explorer.png" alt="codeready-file-explorer">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can ignore the pylint warning</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../asset/images/che-pylint.png" alt="che-pylint">
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_refactor_the_new_model">Refactor the New Model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Next, we will then modify the code into a format that the pipeline can
run to train and build the image with the model. The pipeline will call
<code>train-stage.sh</code> and expects the model to be written to a folder at
<code>/workspace/model</code>.</p>
</div>
<div class="paragraph">
<p>We have prepared the refactored model at <code>/projects/rh-mlops-workshop/src/train/lr.ans.py</code>. Copy it to <code>/projects/rh-mlops-workshop/src/train/lr.py</code>. The python code generated from the notebook has been refactored into a python class and visualization removed.</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cp /projects/rh-mlops-workshop/src/train/lr.ans.py /projects/rh-mlops-workshop/src/train/lr.py</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Copying the file will override the jupytertext converted lr.py.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that in the lr.py file, there is a section on the version of the data used.
The version of the data used is going to be committed together with source, thus allowing us to have reproducible results
easily with dvc.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note that the code directly below this statement is not meant to be run but serves as an illustration for the user to take note of the versioning of the data.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">DATA_VERSION = <span class="string"><span class="delimiter">'</span><span class="content">v1.0</span><span class="delimiter">'</span></span>

<span class="comment"># PIPELINERUN will be set when run from the pipeline</span>
<span class="keyword">if</span> os.environ.get(<span class="string"><span class="delimiter">'</span><span class="content">PIPELINERUN</span><span class="delimiter">'</span></span>, <span class="predefined-constant">None</span>):
    CSV_FILE = <span class="string"><span class="delimiter">'</span><span class="content">creditcard-train.csv</span><span class="delimiter">'</span></span>
<span class="keyword">else</span>:
    CSV_FILE = <span class="string"><span class="delimiter">'</span><span class="content">creditcard.csv</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_train_and_test_the_model">Train And Test The Model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To train the model, run the following script:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cd /projects/rh-mlops-workshop
src/train/train-dev.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The model would have been written to <code>/opt/app-root/src/model</code>.</p>
</div>
<div class="paragraph">
<p>As part of the training, the metrics and model will be logged at <a href="https://mlflow-user1-dev.apps.cluster-844c.844c.example.opentlc.com" target="_blank" rel="noopener">MLflow server</a>.</p>
</div>
<div class="paragraph">
<p>Now start serving the model using REST. A model wrapper has been written to serve the model using Seldon. The model will be loaded and the <code>predict_proba</code> method will be called. Seldon will wrap the model using Flask and expose the port <code>5000</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note that the code directly below this statement is not meant to be run but serves as an illustration of the model wrapper.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">LRModel</span>(Base):
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>):
        <span class="comment"># Load the model</span>
    <span class="keyword">def</span> <span class="function">predict</span>(<span class="predefined-constant">self</span>, X, features_names):
        <span class="comment"># Calls the model predict_proba method</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Serve the model by running <code>app.sh</code>.</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cd /projects/rh-mlops-workshop/src/seldon/
./app.sh</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can ignore this popup box because we are not exposing the route.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../asset/images/che-exposed-route.png" alt="che-exposed-route">
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s test the model. Open up a <strong>new</strong> terminal and run the following:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">/projects/rh-mlops-workshop/bin/dev-test.sh</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the new terminal takes too long to launch or the user interface freezes, try refreshing the browser or restarting the workspace.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The script will send both fraud and non-fraud requests to the model.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_commit_the_code">Commit the Code</h2>
<div class="sectionbody">
<div class="listingblock copypaste">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">cd /projects/rh-mlops-workshop/src/train
git add *
git commit -a -m 'my lr training code'
git push -v origin master</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code has now been pushed to <a href="https://gogs-labs-infra.apps.cluster-844c.844c.example.opentlc.com/user1/rh-mlops-workshop" target="_blank" rel="noopener">your</a> git
repository on the <code>master/devel</code> branch.</p>
</div>
</div>
</div>
        </div>
        <div class="card-footer">
            <a href="building-the-first-model.html" class="btn btn-primary btn-sm pull-left">
              <i class="fa fa-arrow-left"></i> Build the First Model
            </a>
            <a href="deploy-to-staging.html" class="btn btn-primary btn-sm pull-right">
              Deploy The Model To Staging <i class="fa fa-arrow-right"></i>
            </a>
        </div>
      </div>
    </div>
  </div>
</main>


</body>
</html>
